# üìä Gu√≠a de Monitoreo de Tr√°fico - OpenOB Repeater

## Comandos B√°sicos para Monitorear el Tr√°fico

### üéØ Opci√≥n 1: Script Automatizado (Recomendado)
```bash
sudo ./monitor-traffic.sh
```

Opciones disponibles:
- **Opci√≥n 1**: iftop interactivo (visual, tiempo real)
- **Opci√≥n 2**: tcpdump detallado (muestra cada paquete)
- **Opci√≥n 3**: iftop texto (salida simple)
- **Opci√≥n 4**: Estad√≠sticas r√°pidas (resumen de 5 segundos)

---

## üì° Comandos Manuales de iftop

### 1. Monitorear TODO el tr√°fico en eno1
```bash
sudo iftop -i eno1 -P -B
```

**Opciones:**
- `-i eno1`: Especifica la interfaz de red
- `-P`: Muestra n√∫meros de puerto
- `-B`: Muestra velocidad en Bytes (no bits)

### 2. Filtrar SOLO tr√°fico RTP/RTCP (Recomendado para OpenOB)
```bash
sudo iftop -i eno1 -f "port 5004 or port 5005" -P -B
```

**Opciones adicionales:**
- `-f "port 5004 or port 5005"`: Filtra solo puertos RTP y RTCP
- `-n`: No resolver nombres DNS (m√°s r√°pido)
- `-N`: No convertir puertos a nombres de servicio

### 3. Monitorear tr√°fico desde/hacia IPs espec√≠ficas
```bash
# Solo tr√°fico del encoder
sudo iftop -i eno1 -f "host 192.168.18.16" -P -B

# Solo tr√°fico hacia el decoder
sudo iftop -i eno1 -f "host 192.168.18.35" -P -B

# Tr√°fico entre encoder y decoder via repeater
sudo iftop -i eno1 -f "host 192.168.18.16 or host 192.168.18.35" -P -B
```

### 4. Modo texto (para scripts o logging)
```bash
# Captura 10 segundos y guarda en archivo
sudo iftop -i eno1 -f "port 5004 or port 5005" -P -B -t -s 10 > /tmp/traffic.log
```

**Opciones:**
- `-t`: Modo texto (sin interfaz interactiva)
- `-s 10`: Captura por 10 segundos y termina

---

## üîç Comandos tcpdump (An√°lisis Detallado)

### 1. Ver paquetes RTP en tiempo real
```bash
# Ver todos los paquetes RTP
sudo tcpdump -i eno1 -n port 5004

# Ver solo paquetes entrantes (desde encoder)
sudo tcpdump -i eno1 -n dst port 5004 and src 192.168.18.16

# Ver solo paquetes salientes (hacia decoder)
sudo tcpdump -i eno1 -n src port 5004 and dst 192.168.18.35
```

### 2. Contar paquetes en un intervalo
```bash
# Contar paquetes RTP por 5 segundos
timeout 5 sudo tcpdump -i eno1 -n port 5004 2>/dev/null | wc -l

# Calcular tasa de paquetes
PACKETS=$(timeout 5 sudo tcpdump -i eno1 -n port 5004 2>/dev/null | wc -l)
echo "Tasa: $((PACKETS / 5)) paquetes por segundo"
```

### 3. Capturar y analizar detalles
```bash
# Capturar primeros 100 paquetes con detalles
sudo tcpdump -i eno1 -n -v port 5004 -c 100

# Capturar y guardar para an√°lisis posterior (Wireshark)
sudo tcpdump -i eno1 -w /tmp/rtp_capture.pcap port 5004 or port 5005
```

---

## üìà Interpretaci√≥n de Resultados

### iftop - Vista Interactiva

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 192.168.18.16:58517  => 192.168.18.34:5004    1.2MB  1.1MB  1.0MB‚îÇ
‚îÇ 192.168.18.34:5004   => 192.168.18.35:5004    1.2MB  1.1MB  1.0MB‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Interpretaci√≥n:**
- **Primera l√≠nea**: Encoder ‚Üí Repeater (entrada)
- **Segunda l√≠nea**: Repeater ‚Üí Decoder (salida)
- **Columnas**: Promedio de 2s, 10s, 40s
- **Valores esperados**: ~1-2 MB/s para audio PCM est√©reo 48kHz

### Tasas Esperadas para OpenOB

**Audio PCM 48kHz Est√©reo:**
- **Bitrate**: 48000 Hz √ó 2 canales √ó 16 bits = 1536 kbps = **192 KB/s**
- **Con overhead RTP/UDP/IP**: ~220-250 KB/s
- **Paquetes por segundo**: ~50 pps (frames de 20ms)

**Indicadores de Problema:**
- ‚ùå Entrada > 0 pero Salida = 0 ‚Üí Repeater no est√° reenviando
- ‚ùå Entrada = 0 ‚Üí Encoder no est√° transmitiendo
- ‚ùå Tasa muy baja (< 100 KB/s) ‚Üí Audio con p√©rdida o codec diferente

---

## üéÆ Controles Interactivos en iftop

Cuando ejecutas `iftop -i eno1`, puedes usar estas teclas:

| Tecla | Funci√≥n |
|-------|---------|
| `h` | Mostrar ayuda |
| `n` | Toggle resoluci√≥n de nombres |
| `s` | Toggle mostrar fuente |
| `d` | Toggle mostrar destino |
| `t` | Cambiar modo de visualizaci√≥n |
| `p` | Toggle modo promiscuo |
| `P` | Toggle mostrar puertos |
| `l` | Filtro de visualizaci√≥n |
| `q` | Salir |

---

## üöÄ Ejemplos Pr√°cticos

### Escenario 1: Verificar que el repeater est√° recibiendo del encoder
```bash
sudo tcpdump -i eno1 -n "dst 192.168.18.34 and port 5004" -c 10
```

**Output esperado:**
```
10 packets captured
...
192.168.18.16.58517 > 192.168.18.34.5004: UDP, length 1200
192.168.18.16.58517 > 192.168.18.34.5004: UDP, length 1200
...
```

### Escenario 2: Verificar que el repeater est√° enviando al decoder
```bash
sudo tcpdump -i eno1 -n "src 192.168.18.34 and dst 192.168.18.35 and port 5004" -c 10
```

**Output esperado:**
```
10 packets captured
...
192.168.18.34.5004 > 192.168.18.35.5004: UDP, length 1200
192.168.18.34.5004 > 192.168.18.35.5004: UDP, length 1200
...
```

### Escenario 3: Comparar entrada vs salida
```bash
echo "Capturando entrada..."
IN=$(timeout 5 sudo tcpdump -i eno1 -n "dst 192.168.18.34 and port 5004" 2>/dev/null | wc -l)

echo "Capturando salida..."
OUT=$(timeout 5 sudo tcpdump -i eno1 -n "src 192.168.18.34 and dst 192.168.18.35 and port 5004" 2>/dev/null | wc -l)

echo ""
echo "Paquetes entrantes: $IN"
echo "Paquetes salientes: $OUT"
echo "Ratio: $(echo "scale=2; $OUT * 100 / $IN" | bc)%"
```

**Ratio esperado:** ~100% (todos los paquetes se reenv√≠an)

---

## üîß Troubleshooting

### Problema: "iftop: found arguments following options"
**Soluci√≥n:** Usa `-i` antes del nombre de la interfaz:
```bash
# ‚ùå Incorrecto
sudo iftop eno1

# ‚úÖ Correcto
sudo iftop -i eno1
```

### Problema: "Permission denied"
**Soluci√≥n:** Ejecuta con `sudo`:
```bash
sudo iftop -i eno1 -P -B
```

### Problema: "No se ve tr√°fico RTP"
**Verificaciones:**
1. Confirmar que el repeater est√° corriendo: `ps aux | grep openob`
2. Verificar que los puertos est√°n abiertos: `ss -ulpn | grep 5004`
3. Verificar con tcpdump sin filtro: `sudo tcpdump -i eno1 -n port 5004`

### Problema: "Tr√°fico muy bajo"
**Posibles causas:**
1. Encoder no est√° transmitiendo
2. Codec diferente (no PCM)
3. Bitrate reducido
4. P√©rdida de paquetes en la red

---

## üìã Checklist de Verificaci√≥n

- [ ] Repeater est√° corriendo (`ps aux | grep openob`)
- [ ] Puerto 5004 est√° escuchando (`ss -ulpn | grep 5004`)
- [ ] Tr√°fico entrante desde encoder (`sudo tcpdump -i eno1 dst port 5004`)
- [ ] Tr√°fico saliente hacia decoder (`sudo tcpdump -i eno1 src port 5004`)
- [ ] Tasas de entrada y salida son similares
- [ ] Bitrate aproximadamente 192-250 KB/s
- [ ] ~50 paquetes por segundo

---

## üìö Recursos Adicionales

- **Manual de iftop**: `man iftop`
- **Manual de tcpdump**: `man tcpdump`
- **Logs del repeater**: `tail -f /tmp/repeater.log`
- **Verificaci√≥n del sistema**: `./VERIFICACION_SISTEMA.sh`

---

*√öltima actualizaci√≥n: 3 de Octubre 2025*
